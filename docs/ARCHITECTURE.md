# SalesAPI - Architecture Documentation

## Architectural Overview

SalesAPI implements a microservices architecture based on Domain-Driven Design (DDD) and Clean Architecture principles, following industry best practices for distributed systems.

## Architectural Principles

### Clean Architecture
```
???????????????????????????????????????????????
?                  UI Layer                   ? ? Controllers, Middleware
???????????????????????????????????????????????
?               Application Layer             ? ? Use Cases, DTOs, Interfaces
???????????????????????????????????????????????
?                 Domain Layer                ? ? Entities, Value Objects, Rules
???????????????????????????????????????????????
?              Infrastructure Layer           ? ? Data Access, External Services
???????????????????????????????????????????????
```

### Domain-Driven Design (DDD)
- **Bounded Contexts**: Sales, Inventory, Authentication
- **Aggregates**: Order, Product, Customer
- **Domain Events**: OrderCreated, ProductUpdated, StockReserved
- **Value Objects**: Money, ProductId, CustomerId

### CQRS (Command Query Responsibility Segregation)
```
???????????????    ???????????????    ???????????????
?   Commands  ?    ?   Queries   ?    ?    Events   ?
?             ?    ?             ?    ?             ?
? CreateOrder ?    ? GetOrders   ?    ?OrderCreated ?
?UpdateProduct?    ?GetProducts  ?    ?StockUpdated ?
?CancelOrder  ?    ?GetInventory ?    ?OrderCanceled?
???????????????    ???????????????    ???????????????
```

## Microservices Structure

### API Gateway
**Responsibilities**:
- Centralized JWT authentication
- Routing to microservices
- Rate limiting and throttling
- Request logging and correlation
- SSL termination

**Technologies**:
- YARP (Yet Another Reverse Proxy)
- JWT Bearer Authentication
- Structured logging with Serilog

### Sales API
**Responsibilities**:
- Order lifecycle management
- Payment processing coordination
- Saga orchestration
- Integration with Inventory API

**Patterns Implemented**:
- Saga Pattern for distributed transactions
- Event Sourcing for audit trails
- Repository Pattern for persistence
- Mediator Pattern (MediatR)

### Inventory API
**Responsibilities**:
- Product and category management
- Stock control and reservations
- Order event processing
- Inventory reporting

**Patterns Implemented**:
- Event-driven architecture
- CQRS for read/write operations
- Domain Events for notifications
- Optimistic concurrency control

## Messaging Architecture

### Event-Driven Communication
```
Sales API                Event Bus               Inventory API
    ?                        ?                         ?
    ?? OrderCreated ????????????????????????????????????
    ?                        ?                         ?
    ?   ???? StockReserved ??????????????????????????  ?
    ?                        ?                         ?
    ?? PaymentProcessed ????????????????????????????????
    ?                        ?                         ?
    ?   ???? StockAllocated ?????????????????????????  ?
```

### Saga Pattern Implementation
```
Order Processing Saga:
???????????????    ???????????????    ???????????????
? CreateOrder ??????ReserveStock ??????ProcessPayment?
???????????????    ???????????????    ???????????????
       ?                   ?                   ?
       ?                   ?                   ?
???????????????    ???????????????    ???????????????
?CompensateOrder?   ?ReleaseStock ?    ?RefundPayment?
???????????????    ???????????????    ???????????????
```

## Data Persistence Strategy

### Database per Service
```
???????????????    ???????????????    ???????????????
?  Sales DB   ?    ?Inventory DB ?    ? Gateway DB  ?
?             ?    ?             ?    ?             ?
? • Orders    ?    ? • Products  ?    ? • Users     ?
? • OrderItems?    ? • Categories?    ? • Roles     ?
? • Customers ?    ? • Stock     ?    ? • Sessions  ?
???????????????    ???????????????    ???????????????
```

### Entity Framework Core Configuration
- **Connection Pooling**: Performance optimization
- **Migration Strategy**: Code-first with automatic migrations
- **Retry Logic**: Resilience for connection failures
- **Query Optimization**: Tracking disabled for read-only queries

## Security Architecture

### JWT Authentication Flow
```
Client                Gateway              Microservice
  ?                     ?                      ?
  ?? Login Request ??????                      ?
  ?                     ?? Validate Credentials
  ?   ?? JWT Token ??????                      ?
  ?                     ?                      ?
  ?? API Request ????????? Validate JWT ???????
  ?   (with JWT)        ?                      ?
  ?   ???????????????????? Response ???????????
```

### Role-Based Access Control (RBAC)
**Roles:**
- **Admin**
  - Create/Update/Delete Products
  - Manage Users
  - View All Orders
  - System Configuration

- **Customer**
  - View Products
  - Create Orders
  - View Own Orders
  - Update Profile

- **Anonymous**
  - View Products (public)
  - Health Checks
  - Login/Register

## Testing Strategy

### Testing Pyramid
```
                    End-to-End Tests (52)
                   /                      \
                  /        Integration     \
                 /           Tests (4)     \
                /___________________________\
               /                             \
              /        Infrastructure        \
             /            Tests (17)         \
            /_________________________________\
           /                                   \
          /            Domain Tests            \
         /              (33 tests)             \
        /_____________________________________\
```

### Test Patterns Implemented
- **AAA Pattern**: Arrange, Act, Assert
- **Builder Pattern**: Test data creation
- **Object Mother**: Complex object creation
- **Test Fixtures**: Shared test infrastructure
- **In-Memory Providers**: Fast, isolated testing

## Configuration Management

### Configuration Hierarchy
Configuration sources in order of precedence:
1. `appsettings.json` (base configuration)
2. `appsettings.{Environment}.json` (environment-specific)
3. Environment Variables (container/cloud overrides)
4. Command Line Arguments (runtime overrides)

### Environment-Specific Settings
- **Development**: In-memory databases, verbose logging
- **Staging**: SQL Server, moderate logging, feature flags
- **Production**: SQL Server, error logging only, monitoring

## Performance Characteristics

### Throughput Targets
- **Gateway**: 2000+ requests/second
- **Sales API**: 1000+ orders/second
- **Inventory API**: 1500+ product queries/second

### Latency Targets
- **P50**: < 50ms
- **P95**: < 200ms
- **P99**: < 500ms

### Scalability Patterns
- **Horizontal Scaling**: Multiple instance deployment
- **Load Balancing**: Round-robin with health checks
- **Circuit Breaker**: Hystrix pattern implementation
- **Bulkhead**: Resource isolation between services

## Quality Attributes

| Attribute | Current Level | Target Level | Implementation |
|-----------|---------------|--------------|----------------|
| **Performance** | Good | Excellent | Caching, optimization |
| **Scalability** | Good | Excellent | K8s, load balancing |
| **Reliability** | Excellent | Excellent | ? Implemented |
| **Security** | Good | Excellent | Advanced auth |
| **Maintainability** | Excellent | Excellent | ? Implemented |
| **Testability** | Excellent | Excellent | ? Implemented |

## Architecture Decision Records (ADRs)

### ADR-001: Microservices vs Monolith
- **Decision**: Microservices architecture
- **Rationale**: Scalability, team autonomy, technology diversity
- **Consequences**: Increased complexity, distributed system challenges

### ADR-002: Event-Driven Communication
- **Decision**: Asynchronous messaging with RabbitMQ
- **Rationale**: Loose coupling, better scalability, resilience
- **Consequences**: Eventual consistency, debugging complexity

### ADR-003: JWT Authentication
- **Decision**: Stateless JWT tokens
- **Rationale**: Scalability, stateless nature, standard compliance
- **Consequences**: Token management, revocation challenges

### ADR-004: Consolidated Testing Suite
- **Decision**: Single professional test project over multiple mock-heavy projects
- **Rationale**: Reduced duplication, improved reliability, faster execution
- **Consequences**: Better maintainability, consistent patterns

---

*This architectural documentation is maintained and updated with system changes.*